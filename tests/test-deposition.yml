---
- name: test that the defaults are correctly placed
  hosts: localhost
  become: true
  vars_files:
    - vars/irods_environment_opts.yml
  roles:
    - role: ../../ansible-irods-server-cfg

  post_tasks:
    - name: check irods_environment.json deposition
      stat:
        path: /var/lib/irods/.irods/irods_environment.json
      register: response
      failed_when: >
        not response.stat.exists or
        response.stat.pw_name != 'root' or
        response.stat.gr_name != 'irods'


- name: verify contents of irods_environment.json
  hosts: localhost
  gather_facts: false
  become: true
  vars:
    irods_environment: "{{ lookup('file', '/var/lib/irods/.irods/irods_environment.json') }}"
  tasks:
    - name: verify irods_environment.json expands correctly
      assert:
        that:
          - irods_environment.irods_authentication_file == '/auth'
          - irods_environment.irods_authentication_scheme == 'gsi'
          - irods_environment.irods_client_server_negotiation == 'none'
          - irods_environment.irods_client_server_policy == 'CS_NEG_REFUSE'
          - irods_environment.irods_control_plane_key == 'TEMPORARY__32byte_ctrl_plane_ke1'
          - irods_environment.irods_control_plane_port == 5
          - irods_environment.irods_cwd == '/zone'
          - irods_environment.irods_debug == 0
          - irods_environment.irods_default_hash_scheme == 'MD5'
          - irods_environment.irods_default_resource == 'resource'
          - irods_environment.irods_encryption_algorithm == 'algorithm'
          - irods_environment.irods_encryption_key_size == 1
          - irods_environment.irods_encryption_num_hash_rounds == 2
          - irods_environment.irods_encryption_salt_size == 3
          - irods_environment.irods_gsi_server_dn == 'dn'
          - irods_environment.irods_home == '/zone/home'
          - irods_environment.irods_host == 'host'
          - irods_environment.irods_log_level == 4
          - irods_environment.irods_match_hash_policy == 'strict'
          - irods_environment.irods_plugins_home is not defined
          - irods_environment.irods_port == 7
          - irods_environment.irods_ssl_ca_certificate_file == 'certificate_file'
          - irods_environment.irods_ssl_ca_certificate_path == '/path/to/certificates'
          - irods_environment.irods_ssl_certificate_chain_file == 'chain'
          - irods_environment.irods_ssl_certificate_key_file == 'key_file'
          - irods_environment.irods_ssl_dh_params_file == 'params_file'
          - irods_environment.irods_ssl_verify_server == 'cert'
          - irods_environment.irods_user_name == 'user'
          - irods_environment.irods_xmsg_host == 'xmsg_host'
          - irods_environment.irods_xmsg_port == 6
          - irods_environment.irods_zone_name == 'zone'
