---
- name: test that the defaults are correctly placed
  hosts: localhost
  become: true
  roles:
    - role: ../../ansible-irods-server-cfg

  post_tasks:
    - name: check irods_environment.json deposition
      stat:
        path: /var/lib/irods/.irods/irods_environment.json
      register: response
      failed_when: >
        not response.stat.exists or
        response.stat.pw_name != 'irods' or
        response.stat.gr_name != 'irods'


- name: verify default contents of irods_environment.json
  hosts: localhost
  gather_facts: false
  become: true
  vars:
    irods_environment: "{{ lookup('file', '/var/lib/irods/.irods/irods_environment.json') }}"
  tasks:
    - name: verify irods_environment.json expands correctly
      assert:
        that:
          - irods_environment.irods_authentication_file is not defined
          - irods_environment.irods_authentication_scheme == 'native'
          - irods_environment.irods_client_server_negotiation == 'request_server_negotiation'
          - irods_environment.irods_client_server_policy == 'CS_NEG_REFUSE'
          - irods_environment.irods_control_plane_key == 'TEMPORARY__32byte_ctrl_plane_key'
          - irods_environment.irods_control_plane_port == 1248
          - irods_environment.irods_cwd == '/tempZone/home/rods'
          - irods_environment.irods_debug is not defined
          - irods_environment.irods_default_hash_scheme == 'SHA256'
          - irods_environment.irods_default_resource == 'demoResc'
          - irods_environment.irods_encryption_algorithm == 'AES-256-CBC'
          - irods_environment.irods_encryption_key_size == 32
          - irods_environment.irods_encryption_num_hash_rounds == 16
          - irods_environment.irods_encryption_salt_size == 8
          - irods_environment.irods_gsi_server_dn is not defined
          - irods_environment.irods_home == '/tempZone/home/rods'
          - irods_environment.irods_host == 'localhost'
          - irods_environment.irods_log_level is not defined
          - irods_environment.irods_match_hash_policy == 'compatible'
          - irods_environment.irods_plugins_home is not defined
          - irods_environment.irods_port == 1247
          - irods_environment.irods_ssl_ca_certificate_file is not defined
          - irods_environment.irods_ssl_ca_certificate_path is not defined
          - irods_environment.irods_ssl_certificate_chain_file is not defined
          - irods_environment.irods_ssl_certificate_key_file is not defined
          - irods_environment.irods_ssl_dh_params_file is not defined
          - irods_environment.irods_user_name == 'rods'
          - irods_environment.irods_xmsg_host is not defined
          - irods_environment.irods_xmsg_port is not defined
          - irods_environment.irods_zone_name == 'tempZone'
